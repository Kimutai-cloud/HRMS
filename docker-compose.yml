services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: hrms_db
      POSTGRES_USER: hrms_user
      POSTGRES_PASSWORD: hrms_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hrms_user -d hrms_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hrms-network

  # Redis for Auth Service
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - hrms-network

 
  auth-service:
    build: ./Auth-Service
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://hrms_user:hrms_password@postgres:5432/hrms_db
      - JWT_SECRET_KEY=MY_SUPER_SECRET_KEY
      - JWT_ALGORITHM=HS256
      - JWT_AUDIENCE=hrms-services
      - JWT_ISSUER=hrms-auth-service
      - GOOGLE_CLIENT_ID=980394521691-1v0qlhhahpkent9r8efamdvbceq14bal.apps.googleusercontent.com
      - GOOGLE_CLIENT_SECRET=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
      - MAIL_USERNAME=kevin.kimu0306@gmail.com
      - MAIL_PASSWORD=tvcx oncl bfqr zfde
      - MAIL_FROM=kevin.kimu0306@gmail.com
      - MAIL_FROM_NAME=HRMS
      - MAIL_PORT=587
      - MAIL_SERVER=smtp.gmail.com
      - MAIL_STARTTLS=true
      - MAIL_SSL_TLS=false
      - FRONTEND_URL=http://localhost:3000
      - INTERNAL_SERVICE_TOKEN=MY_INTERNAL_SERVICE_TOKEN
      - DEBUG=true
      - LOG_LEVEL=INFO
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./Auth-Service:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - hrms-network

  employee-service:
    build: ./Employee-Service
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql+asyncpg://hrms_user:hrms_password@postgres:5432/hrms_db
      - JWT_SECRET_KEY=MY_SUPER_SECRET_KEY
      - JWT_ALGORITHM=HS256
      - JWT_AUDIENCE=hrms-services
      - JWT_ISSUER=hrms-auth-service
      - AUTH_SERVICE_URL=http://auth-service:8000
      - INTERNAL_SERVICE_TOKEN=MY_INTERNAL_SERVICE_TOKEN
      - DEBUG=true
      - LOG_LEVEL=INFO
      - SERVICE_PORT=8001
    depends_on:
      postgres:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    volumes:
      - ./Employee-Service:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - hrms-network

volumes:
  postgres_data:

networks:
  hrms-network:
    driver: bridge
